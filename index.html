<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisma Aletheia - Noticias de España</title>

    <!-- Local Vendor Scripts -->
    <script src="./vendor/three.min.js"></script>
    <script src="./vendor/globe.gl.min.js"></script>
    <script src="./vendor/lucide.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        #globeViz {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        /* Left Panel */
        .panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 10, 20, 0.85);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            max-width: 320px;
            backdrop-filter: blur(12px);
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #3eabf7;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .subtitle {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: #aaa;
        }

        .date-picker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .icon-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        #currentDate {
            font-weight: 500;
            font-size: 1.1em;
        }

        .news-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 50vh;
            overflow-y: auto;
        }

        .news-list h3 {
            font-size: 0.9em;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .news-list li {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95em;
            line-height: 1.4;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .news-list li:hover {
            background: rgba(62, 171, 247, 0.15);
            border-left: 3px solid #3eabf7;
        }

        .news-list li:last-child {
            border-bottom: none;
        }

        .footer-links {
            margin-top: 20px;
            font-size: 0.8em;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .footer-links a {
            color: #888;
            text-decoration: none;
            margin-right: 15px;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #3eabf7;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* News Marker Styles */
        .news-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            pointer-events: auto;
            transform: translate(-50%, -50%);
        }

        .marker-dot {
            width: 12px;
            height: 12px;
            background: #3eabf7;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 10px #3eabf7, 0 0 20px rgba(62, 171, 247, 0.5);
            animation: pulse 2s infinite;
            transition: transform 0.3s;
        }

        .news-marker:hover .marker-dot {
            transform: scale(1.3);
            background: #fff;
            box-shadow: 0 0 20px #fff;
        }

        .marker-card {
            margin-top: 8px;
            background: rgba(10, 15, 30, 0.9);
            border: 1px solid rgba(62, 171, 247, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            width: 200px;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            text-align: center;
            position: absolute;
            top: 20px;
        }

        .news-marker:hover .marker-card {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            z-index: 100;
        }

        .marker-title {
            font-size: 0.85em;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            line-height: 1.3;
            text-shadow: 0 1px 2px black;
        }

        .marker-source {
            font-size: 0.7em;
            color: #3eabf7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(62, 171, 247, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(62, 171, 247, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(62, 171, 247, 0);
            }
        }

        /* News Reader Panel */
        .news-reader-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 400px;
            background: rgba(10, 15, 30, 0.95);
            border: 1px solid #333;
            border-radius: 12px;
            backdrop-filter: blur(16px);
            z-index: 30;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.7);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .news-reader-panel.open {
            transform: translateX(0);
        }

        .reader-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: rgba(255, 255, 255, 0.02);
        }

        .reader-source {
            color: #3eabf7;
            text-transform: uppercase;
            font-size: 0.8em;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .reader-title {
            margin: 0;
            font-size: 1.6em;
            line-height: 1.3;
            color: white;
        }

        .reader-content {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            font-size: 1.05em;
            line-height: 1.7;
            color: #ddd;
        }

        .reader-content p {
            margin-bottom: 20px;
        }

        .reader-close {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .reader-close:hover {
            color: white;
        }

        .read-more-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(62, 171, 247, 0.1);
            border: 1px solid #3eabf7;
            color: #3eabf7;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .read-more-btn:hover {
            background: #3eabf7;
            color: white;
        }

        /* Chatbot */
        .chatbot-container {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 20;
        }

        .chatbot-toggle {
            background: linear-gradient(135deg, #3eabf7, #0077cc);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(62, 171, 247, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .chatbot-toggle:hover {
            transform: scale(1.05);
        }

        .chatbot-window {
            display: none;
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            background: rgba(15, 15, 25, 0.95);
            border: 1px solid #333;
            border-radius: 16px;
            overflow: hidden;
            flex-direction: column;
            height: 500px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .chatbot-window.open {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .icon-btn-small {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 5px;
        }

        .icon-btn-small:hover {
            color: white;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .message.bot {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .message.user {
            background: #3eabf7;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .message p {
            margin: 0;
        }

        .chat-input-area {
            padding: 15px;
            display: flex;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input-area input:focus {
            border-color: #3eabf7;
        }

        .chat-input-area button {
            background: #3eabf7;
            border: none;
            color: white;
            padding: 0 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-input-area button:hover {
            background: #2d9cdb;
        }
    </style>
</head>

<body>
    <!-- Globe Container -->
    <div id="globeViz"></div>

    <!-- Left Panel -->
    <div class="panel left-panel">
        <div class="header">
            <h1>Noticias de España</h1>
            <p class="subtitle">Visualización en tiempo real</p>
        </div>

        <div class="date-picker">
            <button class="icon-btn"><i data-lucide="chevron-left"></i></button>
            <span id="currentDate">29 Jun 2025</span>
            <button class="icon-btn"><i data-lucide="chevron-right"></i></button>
        </div>

        <div class="news-list">
            <h3>Titulares Destacados</h3>
            <ul id="topNews">
                <!-- Populated by JS -->
            </ul>
        </div>

        <div class="footer-links">
            <a href="#">Sobre nosotros</a>
            <a href="#">Fuentes</a>
        </div>
    </div>

    <!-- News Reader Panel -->
    <div class="news-reader-panel" id="newsReader">
        <div class="reader-header">
            <div>
                <span class="reader-source" id="readerSource">Fuente</span>
                <h2 class="reader-title" id="readerTitle">Título de la noticia</h2>
            </div>
            <button class="reader-close" onclick="closeArticle()"><i data-lucide="x"></i></button>
        </div>
        <div class="reader-content" id="readerContent">
            <!-- Content injected here -->
        </div>
    </div>

    <!-- Chatbot Interface -->
    <div class="chatbot-container">
        <button id="chatbotToggle" class="chatbot-toggle">
            <i data-lucide="message-circle"></i>
        </button>

        <div class="chatbot-window" id="chatbotWindow">
            <div class="chat-header">
                <div class="chat-title">
                    <i data-lucide="bot"></i>
                    <span>Asistente IA</span>
                </div>
                <button id="chatbotClose" class="icon-btn-small"><i data-lucide="x"></i></button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <p>Hola. Soy tu asistente de noticias. ¿En qué puedo ayudarte hoy?</p>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
                <button id="chatSend"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>

    <script>
        // News Data
        const newsData = [
            {
                city: "Madrid",
                lat: 40.4168,
                lng: -3.7038,
                title: "Las seis vidas segadas en una semana dramática de violencia machista",
                summary: "Entre el martes y el miércoles fueron hallados los cuerpos de cinco mujeres asesinadas a manos de sus parejas. La sociedad española se encuentra conmocionada por esta ola de crímenes que pone de manifiesto la persistencia de la violencia de género. Las asociaciones feministas han convocado manifestaciones en las principales plazas del país para exigir medidas más contundentes y una mayor protección para las víctimas.",
                source: "El País",
                url: "https://elpais.com/sociedad/2025-06-28/las-seis-vidas-segadas-en-una-semana-dramatica-de-violencia-machista.html"
            },
            {
                city: "Almería",
                lat: 36.8340,
                lng: -2.4637,
                title: "Detenido un hombre por el asesinato de su mujer en Almería",
                summary: "La Policía Nacional ha detenido a un hombre de 60 años como presunto asesino de su mujer en un domicilio de la capital almeriense. Los vecinos alertaron a las autoridades tras escuchar fuertes discusiones. Este nuevo caso eleva la cifra de víctimas mortales en lo que va de año, generando una respuesta inmediata de las instituciones locales.",
                source: "El País",
                url: "https://elpais.com/espana/2025-06-28/detenido-un-hombre-por-el-asesinato-de-su-mujer-en-almeria.html"
            },
            {
                city: "Madrid (Tribunal Supremo)",
                lat: 40.4240,
                lng: -3.6938,
                title: "Protesta de jueces y fiscales contra la reforma judicial",
                summary: "Cientos de manifestantes, entre ellos jueces y fiscales de toda España, se han congregado frente al Tribunal Supremo para protestar contra la reciente reforma judicial impulsada por el Gobierno. Los convocantes denuncian que la reforma pone en peligro la independencia del poder judicial y politiza la justicia.",
                source: "El País",
                url: "https://elpais.com/espana/2025-06-28/multitudinaria-protesta-de-jueces-y-fiscales-contra-la-reforma-judicial-al-supremo.html"
            },
            {
                city: "Sevilla",
                lat: 37.3891,
                lng: -5.9845,
                title: "Arranca la primera ola de calor",
                summary: "La primera ola de calor del verano ha llegado con fuerza. El 77% de los municipios españoles se encuentran en niveles de riesgo para la salud debido a las altas temperaturas, que en algunos puntos del valle del Guadalquivir podrían superar los 44 grados. Las autoridades recomiendan extremar las precauciones, hidratarse y evitar la exposición al sol en las horas centrales del día.",
                source: "El País",
                url: "https://elpais.com/clima-y-medio-ambiente/2025-06-28/la-primera-ola-de-calor-arranca-con-el-75-de-los-municipios-en-niveles-de-riesgo-para-la-salud.html"
            },
            {
                city: "Budapest",
                lat: 47.4979,
                lng: 19.0402,
                title: "Claves del Orgullo prohibido en Budapest",
                summary: "Hungría celebra hoy su manifestación por los derechos LGTBIQ+ más compleja en un ambiente de alta tensión política y social. A pesar de las restricciones y la retórica hostil del gobierno, miles de personas han salido a las calles para reivindicar la libertad y la igualdad, convirtiendo el evento en un símbolo de resistencia en Europa Central.",
                source: "El País",
                url: "https://elpais.com/sociedad/lgtb/2025-06-28/claves-del-orgullo-prohibido-de-budapest.html"
            },
            {
                city: "Madrid (Zarzuela)",
                lat: 40.4820,
                lng: -3.7964,
                title: "Marta Carazo, nueva jefa de la Secretaría de la Reina",
                summary: "La periodista de TVE, Marta Carazo, ha sido nombrada nueva jefa de la Secretaría de la Reina Letizia. Asumirá el cargo a partir de septiembre, convirtiéndose en una pieza clave en la comunicación y agenda de la Casa Real. Su perfil periodístico y su experiencia en corresponsalías internacionales han sido determinantes para su elección.",
                source: "El País",
                url: "https://elpais.com/espana/2025-06-28/marta-carazo-periodista-de-tve-nueva-jefa-de-la-secretaria-de-la-reina.html"
            },
            {
                city: "Madrid (Congreso)",
                lat: 40.4160,
                lng: -3.6960,
                title: "Trump, Peinado y González, ¿al rescate de Sánchez?",
                summary: "Un análisis detallado sobre cómo los recientes eventos internacionales, incluyendo la situación legal de Trump y las decisiones judiciales locales, podrían estar influyendo indirectamente en la estabilidad política del presidente Pedro Sánchez. Expertos debaten si estos factores externos están sirviendo como cortina de humo o como catalizadores para el gobierno actual.",
                source: "El País",
                url: "https://elpais.com/espana/2025-06-28/trump-peinado-y-gonzalez-al-rescate-de-sanchez.html"
            },
            {
                city: "Venecia",
                lat: 45.4408,
                lng: 12.3155,
                title: "Boda de Jeff Bezos y Lauren Sánchez en Venecia",
                summary: "La ciudad de los canales ha sido testigo de la fastuosa boda entre Jeff Bezos y Lauren Sánchez. El evento culminó con un baile de máscaras exclusivo, aunque no estuvo exento de polémica, ya que grupos locales organizaron una manifestación contra el impacto del turismo de lujo y la privatización de espacios públicos para eventos privados.",
                source: "El País",
                url: "https://elpais.com/gente/2025-06-28/fin-de-fiesta-de-jeff-bezos-y-lauren-sanchez-en-venecia-baile-de-mascaras-y-manifestacion-contra-la-boda.html"
            },
            {
                city: "California (Western States)",
                lat: 39.0968,
                lng: -120.0324,
                title: "Kilian Jornet: 'Hay momentos en que no sé si estoy vivo o muerto'",
                summary: "El legendario atleta de montaña Kilian Jornet regresa a la mítica carrera Western States de 100 millas en California. En una entrevista exclusiva, reflexiona sobre los límites del cuerpo humano, el sufrimiento extremo y la conexión espiritual con la naturaleza que experimenta durante estas pruebas de ultra resistencia.",
                source: "El País",
                url: "https://elpais.com/deportes/2025-06-28/kilian-jornet-hay-momentos-en-que-no-se-si-estoy-vivo-o-muerto.html"
            },
            {
                city: "Valencia",
                lat: 39.4699,
                lng: -0.3763,
                title: "El auge del ventilador de techo",
                summary: "Ante el encarecimiento de la energía y la búsqueda de soluciones más sostenibles, el ventilador de techo está viviendo una segunda juventud. Este verano amenaza con destronar al aire acondicionado como el rey de la climatización doméstica, gracias a su eficiencia energética y a los nuevos diseños silenciosos y estéticos.",
                source: "El País",
                url: "https://elpais.com/economia/negocios/2025-06-28/el-gran-hit-del-verano-contra-el-calor-por-que-el-ventilador-de-techo-amenaza-el-reinado-del-aire-acondicionado.html"
            },
            {
                city: "Teherán",
                lat: 35.6892,
                lng: 51.3890,
                title: "Funerales multitudinarios en Irán",
                summary: "Irán ha vivido una jornada de luto nacional con funerales de Estado multitudinarios por los altos cargos asesinados recientemente. El régimen ha utilizado estos actos para cerrar filas y mostrar fuerza ante la comunidad internacional, en un momento de máxima tensión geopolítica en la región.",
                source: "El País",
                url: "https://elpais.com/internacional/2025-06-28/iran-cierra-filas-con-los-funerales-por-los-altos-cargos-asesinados-por-israel.html"
            },
            {
                city: "Gaza",
                lat: 31.5017,
                lng: 34.4668,
                title: "Conflicto en Oriente Próximo: Última hora",
                summary: "La situación en Gaza continúa siendo crítica. En las últimas horas, ataques aéreos han dejado al menos 12 palestinos muertos. Mientras tanto, los esfuerzos diplomáticos internacionales parecen estancados, y la población civil sigue sufriendo las consecuencias devastadoras del conflicto prolongado.",
                source: "El País",
                url: "https://elpais.com/internacional/2025-06-28/ultima-hora-del-conflicto-en-oriente-proximo-en-directo.html"
            },
            {
                city: "Washington D.C.",
                lat: 38.9072,
                lng: -77.0369,
                title: "El Supremo de EE UU limita el poder de los jueces",
                summary: "En una decisión histórica que supone una victoria para la agenda de Donald Trump, el Tribunal Supremo de EE. UU. ha limitado significativamente la capacidad de los jueces federales para bloquear políticas gubernamentales. Expertos legales advierten que esto podría alterar el equilibrio de poderes en la democracia estadounidense.",
                source: "El País",
                url: "https://elpais.com/internacional/2025-06-27/el-supremo-de-ee-uu-limita-el-poder-de-los-jueces-para-oponerse-a-la-agenda-de-trump.html"
            },
            {
                city: "Lavapiés (Madrid)",
                lat: 40.4087,
                lng: -3.7005,
                title: "El camino imposible de los inmigrantes sin papeles",
                summary: "Un reportaje en profundidad sobre la vida de los inmigrantes irregulares en España. A través de testimonios desde el barrio de Lavapiés, se narra la odisea de vivir años en la clandestinidad, sin derechos básicos y con el miedo constante a la expulsión, mientras intentan construir un futuro digno.",
                source: "El País",
                url: "https://elpais.com/espana/2025-06-28/anos-en-la-clandestinidad-el-camino-imposible-de-los-inmigrantes-sin-papeles-en-espana.html"
            }
        ];

        // Initialize Globe variable
        let world;

        // News Reader Logic
        const readerPanel = document.getElementById('newsReader');
        const readerSource = document.getElementById('readerSource');
        const readerTitle = document.getElementById('readerTitle');
        const readerContent = document.getElementById('readerContent');

        function openArticle(data) {
            readerSource.textContent = data.source + " • " + data.city;
            readerTitle.textContent = data.title;

            // Simulate fuller content by repeating summary if short, or just showing summary
            readerContent.innerHTML = `
                <p><strong>${data.city}</strong> — ${data.summary}</p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <a href="${data.url}" target="_blank" class="read-more-btn">Leer artículo original <i data-lucide="external-link" style="width: 14px; vertical-align: middle;"></i></a>
            `;

            readerPanel.classList.add('open');
            lucide.createIcons(); // Refresh icons in new content

            // Fly to location
            if (world) {
                world.pointOfView({ lat: data.lat, lng: data.lng, altitude: 1.2 }, 2000);
                world.controls().autoRotate = false;
            }
        }

        function closeArticle() {
            readerPanel.classList.remove('open');
        }

        // Populate Left Panel News List
        const newsList = document.getElementById('topNews');
        newsData.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item.title;
            li.title = item.summary;
            li.onclick = () => openArticle(item);
            newsList.appendChild(li);
        });

        // Constants
        const CLOUDS_ALT = 0.004;
        const CLOUDS_ROTATION_SPEED = 0.006;

        window.addEventListener('load', () => {
            if (!window.THREE || typeof Globe === 'undefined') {
                console.error("Missing dependencies");
                return;
            }

            // Load Textures
            const textureLoader = new THREE.TextureLoader();
            const dayTexture = textureLoader.load('./img/earth-blue-marble.jpg');
            const nightTexture = textureLoader.load('./img/earth-night.jpg');
            const cloudTexture = textureLoader.load('./img/earth-clouds.png');

            console.log("Loading textures...");

            // Sun Direction
            const sunDir = new THREE.Vector3(-1, 0.5, 1.5).normalize();

            // Custom Earth Shader Material
            const earthMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    dayTexture: { value: dayTexture },
                    nightTexture: { value: nightTexture },
                    sunDirection: { value: sunDir }
                },
                vertexShader: `
                    varying vec2 vUv;
                    varying vec3 vNormal;
                    void main() {
                        vUv = uv;
                        vNormal = normalize(mat3(modelMatrix) * normal);
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D dayTexture;
                    uniform sampler2D nightTexture;
                    uniform vec3 sunDirection;
                    varying vec2 vUv;
                    varying vec3 vNormal;

                    void main() {
                        vec3 dayColor = texture2D(dayTexture, vUv).rgb;
                        vec3 nightColor = texture2D(nightTexture, vUv).rgb;
                        float intensity = dot(vNormal, sunDirection);
                        float mixFactor = smoothstep(-0.1, 0.1, intensity);
                        vec3 finalColor = mix(nightColor, dayColor, mixFactor);
                        gl_FragColor = vec4(finalColor, 1.0);
                    }
                `
            });

            // Initialize Globe
            world = Globe()
                (document.getElementById('globeViz'))
                .globeMaterial(earthMaterial)
                .backgroundImageUrl('./img/night-sky.png')
                .pointOfView({ lat: 40.4168, lng: -3.7038, altitude: 1.5 })
                .htmlElementsData(newsData)
                .htmlLat('lat')
                .htmlLng('lng')
                .htmlElement(d => {
                    const el = document.createElement('div');
                    el.className = 'news-marker';
                    el.innerHTML = `
                        <div class="marker-dot"></div>
                        <div class="marker-card">
                            <div class="marker-source">${d.source}</div>
                            <div class="marker-title">${d.title}</div>
                        </div>
                    `;
                    el.onclick = (e) => {
                        e.stopPropagation(); // Prevent map click
                        openArticle(d);
                    };
                    return el;
                })
                .showAtmosphere(true)
                .atmosphereColor('lightskyblue')
                .atmosphereAltitude(0.15)
                .onGlobeClick(() => closeArticle()); // Close panel when clicking globe

            // Add Clouds
            const clouds = new THREE.Mesh(
                new THREE.SphereGeometry(world.getGlobeRadius() * (1 + CLOUDS_ALT), 75, 75),
                new THREE.MeshPhongMaterial({
                    map: cloudTexture,
                    transparent: true,
                    opacity: 0.55,
                    side: THREE.DoubleSide
                })
            );
            world.scene().add(clouds);
            console.log("Clouds added to scene");

            // Lighting
            const scene = world.scene();
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.copy(sunDir);
            scene.add(sunLight);

            // Animation Loop
            (function animate() {
                clouds.rotation.y += CLOUDS_ROTATION_SPEED * Math.PI / 180;
                requestAnimationFrame(animate);
            })();

            // Initialize Icons
            lucide.createIcons();
        });

        // Chatbot Logic
        const chatbotClose = document.getElementById('chatbotClose');
        const chatbotToggle = document.getElementById('chatbotToggle');
        const chatbotWindow = document.getElementById('chatbotWindow');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        function toggleChat() {
            chatbotWindow.classList.toggle('open');
        }

        chatbotToggle.addEventListener('click', toggleChat);
        chatbotClose.addEventListener('click', toggleChat);

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender);
            div.innerHTML = `<p>${text}</p>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleSend() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            chatInput.value = '';

            setTimeout(() => {
                const responses = [
                    "Entiendo. ¿Te gustaría saber más sobre esa noticia?",
                    "Puedo buscar más información en los periódicos españoles.",
                    "Ese es un tema interesante. Aquí tienes un resumen...",
                    "Lo siento, solo soy una interfaz de demostración por ahora."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'bot');
            }, 1000);
        }

        chatSend.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });
    </script>
</body>

</html>